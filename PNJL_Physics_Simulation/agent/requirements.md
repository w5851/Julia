# PNJL 物理仿真项目需求文档

## 项目状态概览
- **项目阶段**: 功能优化和重构阶段
- **当前版本**: v1.0-dev
- **最后更新**: 2025年8月18日

## 当前需求状态

### 🔴 高优先级需求（紧急）

#### 1. 数值稳定性修复
- **状态**: ✅ 已完成
- **描述**: 修复 `calculate_U` 函数中的对数负值问题
- **文件**: `Function_PNJL_aniso.jl`
- **具体任务**:
  - [x] 识别 `log(value)` 可能出现负值的情况
  - [x] 实现安全对数函数 `safe_log`
  - [x] 替换所有不安全的对数调用
  - [x] 测试边界条件处理
- **完成时间**: 2025年8月18日
- **责任人**: 开发者
- **影响范围**: 核心计算稳定性

#### 2. 有限差分步长优化
- **状态**: 待开始
- **描述**: 优化 `central_fdm` 方法的步长控制
- **文件**: `Function_PNJL_aniso.jl`
- **具体任务**:
  - [ ] 分析当前步长选择的问题
  - [ ] 实现自适应步长或手动步长控制
  - [ ] 验证数值精度改进
  - [ ] 性能基准测试
- **预期完成时间**: 2天
- **依赖**: 数值稳定性修复完成

### 🟡 中优先级需求（重要）

#### 3. 代码架构重构
- **状态**: 设计阶段
- **描述**: 将现有代码重构为高内聚低耦合的模块化架构
- **具体任务**:
  - [ ] 设计抽象接口和类型系统
  - [ ] 拆分 `Function_PNJL_aniso.jl` 为多个功能模块
  - [ ] 实现 Core、Models、Physics 模块分离
  - [ ] 定义统一的计算接口
- **预期完成时间**: 1周
- **影响范围**: 整个项目结构

#### 4. 接口函数文档化
- **状态**: 待开始
- **描述**: 为所有公开接口编写详细文档
- **具体任务**:
  - [ ] 识别所有公开接口函数
  - [ ] 编写标准化的函数文档
  - [ ] 创建使用示例
  - [ ] 添加类型签名和约束说明
- **预期完成时间**: 3天
- **依赖**: 架构重构进行中

### 🟢 低优先级需求（改进）

#### 5. 性能优化
- **状态**: 分析阶段
- **描述**: 优化关键计算路径的性能
- **具体任务**:
  - [ ] 使用 `@benchmark` 识别性能瓶颈
  - [ ] 优化内存分配和类型稳定性
  - [ ] 考虑并行计算可能性
  - [ ] 缓存计算结果
- **预期完成时间**: 1周
- **影响范围**: 计算效率

#### 6. 测试套件完善
- **状态**: 部分完成
- **描述**: 建立完整的测试覆盖
- **具体任务**:
  - [ ] 单元测试：每个函数独立测试
  - [ ] 集成测试：模块间交互测试
  - [ ] 边界测试：极限条件测试
  - [ ] 回归测试：确保修改不破坏现有功能
- **预期完成时间**: 1周

## 具体功能需求

### 核心计算模块需求

#### 安全数学函数库
```julia
# 需要实现的安全函数
function safe_log(x; min_val=1e-16, handle_negative=:clamp)
function safe_exp(x; max_val=700.0)
function safe_sqrt(x; min_val=0.0)
```

#### 热力学计算接口
```julia
abstract type ThermodynamicSystem end
function calculate_pressure(system::ThermodynamicSystem, state...)
function calculate_derivatives(system::ThermodynamicSystem, state...)
```

### 物理模型需求

#### PNJL 模型抽象
```julia
struct PNJLModel <: PhysicsModel
    constants::PNJLConstants
    parameters::PNJLParameters
end

function solve_equations(model::PNJLModel, conditions...)
```

#### 相变计算模块
```julia
function phase_transition_analysis(model, T_range, rho_range)
function critical_point_finder(model)
```

## 技术债务清单

### 代码质量问题
1. **类型不稳定性**: `Function_PNJL_aniso.jl` 中存在类型推断问题
2. **硬编码常数**: 魔法数字散布在代码中，需要集中管理
3. **函数过长**: 部分函数超过100行，需要拆分
4. **错误处理不足**: 缺少异常情况的优雅处理

### 性能问题
1. **内存分配**: 循环中创建临时数组
2. **重复计算**: 相同表达式在循环中重复计算
3. **自动微分开销**: ForwardDiff 在某些场景下效率低

### 可维护性问题
1. **文档缺失**: 大部分函数缺少使用文档
2. **测试覆盖不足**: 核心功能缺少测试
3. **依赖混乱**: 模块间循环依赖

## 长期规划需求

### 第一阶段（当前）：稳定性和重构
- 修复数值稳定性问题
- 建立模块化架构
- 完善文档和测试

### 第二阶段：功能扩展
- 支持更多物理模型
- 实现图形化结果展示
- 添加并行计算支持

### 第三阶段：性能和易用性
- 全面性能优化
- 提供用户友好的 API
- 集成到 Julia 包生态系统

## 质量标准

### 代码质量指标
- **测试覆盖率**: > 80%
- **文档覆盖率**: 100%（所有公开接口）
- **类型稳定性**: 无类型推断警告
- **性能回归**: < 5%

### 文档标准
- 每个公开函数必须有完整的 docstring
- 包含参数说明、返回值、使用示例
- 物理背景和数学公式说明
- 边界条件和错误处理说明

---

## 更新日志
- **2025-08-18**: 初始需求文档创建
- **2025-08-18**: 识别对数函数负值问题，添加到高优先级需求

---

**注意**: 本文档是活文档，每次代码更新后都需要相应更新需求状态。完成的需求标记为 [x]，进行中的需求保持 [ ] 并更新进度。
