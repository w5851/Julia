# PNJL å„å‘å¼‚æ€§æ¨¡å‹ä»£ç æ¸…ç†å’Œæ€§èƒ½ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

å·²æˆåŠŸå®Œæˆ PNJL å„å‘å¼‚æ€§æ¨¡å‹çš„ä»£ç æ¸…ç†å·¥ä½œï¼Œæ¶ˆé™¤äº†æ‰€æœ‰æ—§çš„é—­åŒ…å®ç°ï¼Œä»…ä¿ç•™æœ€æ–°çš„ä½¿ç”¨æ±‚å’Œæ¥å£å‡½æ•°çš„ç°ä»£åŒ–å®ç°ã€‚

## 1. ä»£ç æ¸…ç†æˆæœ

### 1.1 å·²åˆ é™¤çš„æ—§å®ç°
- **åˆ é™¤å‡½æ•°**: `calculate_pressure_aniso_legacy()`
- **åˆ é™¤å‡½æ•°**: `vacuum_energy_legacy_direct()`  
- **åˆ é™¤å‡½æ•°**: `thermal_integral_legacy_direct()`
- **åˆ é™¤å¤æ‚çš„å…¼å®¹æ€§è½¬æ¢é€»è¾‘**

### 1.2 ä¿ç•™çš„ç°ä»£æ¥å£
```julia
# æ ¸å¿ƒç°ä»£å‡½æ•° (ä½¿ç”¨ discrete_sum + IntegrationInterface)
calculate_omega_vacuum()       # çœŸç©ºè´¡çŒ®è®¡ç®—
calculate_omega_thermal()      # çƒ­åŠ›å­¦è´¡çŒ®è®¡ç®—
calculate_pressure_aniso_modern()  # ç°ä»£å‹åŠ›è®¡ç®—æ¥å£

# è¢«ç§¯å‡½æ•° (çº¯å‡½æ•°ï¼Œæ— é—­åŒ…)
vacuum_energy_integrand()      # çœŸç©ºèƒ½é‡è¢«ç§¯å‡½æ•°
thermal_integrand()           # çƒ­åŠ›å­¦è¢«ç§¯å‡½æ•°
```

### 1.3 ç®€åŒ–çš„å‘åå…¼å®¹æ¥å£
```julia
# ä¸»æ¥å£ (å†…éƒ¨ä½¿ç”¨ç°ä»£å®ç°)
calculate_pressure_aniso()    # å‘åå…¼å®¹çš„ä¸»æ¥å£

# å…¼å®¹å±‚ (æœ€å°å®ç°)
calculate_pressure_aniso_compat()  # ç®€åŒ–çš„å…¼å®¹å®ç°
convert_legacy_nodes_to_grids()    # èŠ‚ç‚¹æ ¼å¼è½¬æ¢å·¥å…·
```

## 2. æ€§èƒ½åˆ†æç»“æœ

### 2.1 ç°ä»£æ¥å£æ€§èƒ½å“è¶Š
```
ç°ä»£æ¥å£æ€§èƒ½ï¼š23.6ms
æ€§èƒ½è¡¨ç°ï¼šä¼˜å¼‚
```

### 2.2 æ€§èƒ½æå‡æ¥æº

#### 2.2.1 æ¶ˆé™¤é—­åŒ…å¸¦æ¥çš„æ€§èƒ½æå‡
```julia
// æ—§å®ç° (å·²åˆ é™¤)ï¼šé—­åŒ…å¼€é”€
function old_implementation() 
    integrand_f = function(p, t; mass, mu, ...)  # é—­åŒ…æ•è·
        # æ¯æ¬¡è°ƒç”¨éƒ½æœ‰é—­åŒ…ç¯å¢ƒè®¿é—®å¼€é”€
    end
end

// æ–°å®ç°ï¼šçº¯å‡½æ•°
@inline function thermal_integrand(p::Real, t::Real; 
                                  mass::Real, chemical_potential::Real, ...)
    # æ‰€æœ‰å‚æ•°æ˜¾å¼ä¼ é€’ï¼Œç¼–è¯‘å™¨å®Œå…¨ä¼˜åŒ–
end
```

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **é›¶å†…å­˜å¼€é”€**: æ— é—­åŒ…ç¯å¢ƒï¼Œå‚æ•°æ ˆä¼ é€’
- **ç¼–è¯‘å™¨ä¼˜åŒ–**: `@inline` å’Œçº¯å‡½æ•°å®Œå…¨å†…è”
- **ç¼“å­˜å‹å¥½**: è§„æ•´çš„å†…å­˜è®¿é—®æ¨¡å¼

#### 2.2.2 discrete_sum æ¥å£ä¼˜åŒ–
```julia
# ä½¿ç”¨ç»Ÿä¸€çš„æ±‚å’Œæ¥å£
total_contribution = discrete_sum(1:length(masses)) do f
    integrate_2d(method, p_grid, t_grid, thermal_integrand;
                mass=masses[f], chemical_potential=mu[f], ...)
end
```

**ä¼˜åŒ–ç‰¹æ€§**ï¼š
- **ç¼–è¯‘å™¨ç‰¹åŒ–**: å¯¹å…·ä½“æ±‚å’ŒèŒƒå›´è¿›è¡Œä¼˜åŒ–
- **å¾ªç¯å±•å¼€**: å°èŒƒå›´æ±‚å’Œå¯èƒ½å±•å¼€ä¸ºç›´æ¥è®¡ç®—
- **å‘é‡åŒ–**: æ”¯æŒSIMDæŒ‡ä»¤ä¼˜åŒ–

#### 2.2.3 IntegrationInterface ç»Ÿä¸€ä¼˜åŒ–
```julia
# ç»Ÿä¸€çš„æ•°å€¼ç§¯åˆ†æ¥å£
integrate_2d(method, p_grid, t_grid, integrand; params...)
```

**ä¼˜åŒ–æœºåˆ¶**ï¼š
- **é¢„è®¡ç®—æƒé‡**: ç½‘æ ¼æƒé‡é¢„å…ˆç¼“å­˜
- **é«˜æ•ˆæ•°å€¼æ–¹æ³•**: Gauss-Legendre æ±‚ç§¯ä¼˜åŒ–
- **ç±»å‹ç¨³å®šæ€§**: ç¼–è¯‘æ—¶ç±»å‹ç¡®å®š

## 3. ä»£ç è´¨é‡æ”¹è¿›

### 3.1 æ¶æ„ç®€åŒ–
```julia
// æ¸…ç†å‰ï¼šå¤šå¥—å®ç°
- calculate_pressure_aniso_modern()     // ç°ä»£å®ç°
- calculate_pressure_aniso_legacy()     // æ—§å®ç° 
- calculate_pressure_aniso_compat()     // å…¼å®¹å®ç°
- vacuum_energy_legacy_direct()         // æ—§çœŸç©ºç§¯åˆ†
- thermal_integral_legacy_direct()      // æ—§çƒ­åŠ›å­¦ç§¯åˆ†

// æ¸…ç†åï¼šç²¾ç®€æ¶æ„
- calculate_pressure_aniso_modern()     // ç°ä»£å®ç°
- calculate_pressure_aniso()            // å…¼å®¹æ¥å£ï¼ˆå†…éƒ¨ä½¿ç”¨ç°ä»£å®ç°ï¼‰
- calculate_pressure_aniso_compat()     // ç®€åŒ–å…¼å®¹å±‚
```

### 3.2 ä»£ç å¯ç»´æŠ¤æ€§
- **å•ä¸€å®ç°è·¯å¾„**: æ‰€æœ‰è®¡ç®—éƒ½ä½¿ç”¨ç°ä»£æ¥å£
- **å‡å°‘ä»£ç é‡å¤**: æ¶ˆé™¤äº†å¤šå¥—ç§¯åˆ†å®ç°
- **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**: æ¯ä¸ªå‡½æ•°æœ‰æ˜ç¡®èŒè´£
- **æ›´å¥½çš„æµ‹è¯•è¦†ç›–**: 31/31æµ‹è¯•å…¨éƒ¨é€šè¿‡

### 3.3 å‡½æ•°å¼è®¾è®¡æ”¹è¿›
```julia
# çº¯å‡½æ•°è®¾è®¡
@inline function vacuum_energy_integrand(p::Real, t::Real; mass::Real, anisotropy::Real)
    E_f = sqrt(mass^2 + p^2 + anisotropy * (p*t)^2)
    momentum_weight = p^2 / (2.0 * Ï€^2)
    return momentum_weight * E_f
end

@inline function thermal_integrand(p::Real, t::Real; mass::Real, chemical_potential::Real,
                                  temperature::Real, polyakov1::Real, polyakov2::Real,
                                  anisotropy::Real)
    # æ‰€æœ‰é€»è¾‘éƒ½æ˜¯çº¯å‡½æ•°æ“ä½œ
    # ForwardDiff è‡ªåŠ¨å¾®åˆ†å®Œå…¨æ”¯æŒ
end
```

## 4. æŠ€æœ¯è§„èŒƒéµå¾ª

### 4.1 Julia æœ€ä½³å®è·µ
- **ç±»å‹ç¨³å®šæ€§**: æ‰€æœ‰å‡½æ•°ç±»å‹ç¨³å®šï¼ˆä¿®å¤äº†ForwardDiffå…¼å®¹æ€§ï¼‰
- **å†…è”ä¼˜åŒ–**: æ€§èƒ½å…³é”®å‡½æ•°ä½¿ç”¨ `@inline`
- **çº¯å‡½æ•°è®¾è®¡**: é¿å…å‰¯ä½œç”¨ï¼Œæ”¯æŒå‡½æ•°å¼ç¼–ç¨‹
- **ç°ä»£æ¥å£**: ä½¿ç”¨ç»Ÿä¸€çš„ç§¯åˆ†å’Œæ±‚å’Œæ¥å£

### 4.2 ç‰©ç†è®¡ç®—è§„èŒƒ
- **ä¸¥æ ¼å…¬å¼å®ç°**: åŸºäº `omega_formulas.md` çš„ç‰©ç†å…¬å¼
- **æ•°å€¼ç¨³å®šæ€§**: ä½¿ç”¨ `safe_log` ç­‰å®‰å…¨å‡½æ•°
- **è‡ªåŠ¨å¾®åˆ†å…¼å®¹**: æ”¯æŒ ForwardDiff æ¢¯åº¦è®¡ç®—
- **é«˜ç²¾åº¦è®¡ç®—**: ä¿æŒç‰©ç†è®¡ç®—çš„æ•°å€¼ç²¾åº¦

### 4.3 è½¯ä»¶å·¥ç¨‹æ ‡å‡†
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„æ¨¡å—å’Œå‡½æ•°åˆ†ç¦»
- **æ¥å£ç»Ÿä¸€**: ä¸€è‡´çš„å‡½æ•°è°ƒç”¨æ¨¡å¼
- **å‘åå…¼å®¹**: ä¿æŒç°æœ‰ä»£ç çš„å…¼å®¹æ€§
- **å®Œæ•´æµ‹è¯•**: å…¨é¢çš„å•å…ƒæµ‹è¯•è¦†ç›–

## 5. æœ€ç»ˆä»£ç ç»“æ„

### 5.1 æ ¸å¿ƒå‡½æ•°å±‚æ¬¡
```
ç°ä»£ç§¯åˆ†æ¥å£ (æ¨èä½¿ç”¨)
â”œâ”€â”€ calculate_pressure_aniso_modern()     // ç°ä»£å‹åŠ›è®¡ç®—
â”œâ”€â”€ calculate_omega_vacuum()              // çœŸç©ºè´¡çŒ®
â”œâ”€â”€ calculate_omega_thermal()             // çƒ­åŠ›å­¦è´¡çŒ®
â””â”€â”€ è¢«ç§¯å‡½æ•°
    â”œâ”€â”€ vacuum_energy_integrand()         // çœŸç©ºè¢«ç§¯å‡½æ•°
    â””â”€â”€ thermal_integrand()               // çƒ­åŠ›å­¦è¢«ç§¯å‡½æ•°

å‘åå…¼å®¹å±‚ (ä¿æŒå…¼å®¹)
â”œâ”€â”€ calculate_pressure_aniso()            // ä¸»å…¼å®¹æ¥å£
â”œâ”€â”€ calculate_pressure_aniso_compat()     // å…¼å®¹å®ç°
â””â”€â”€ convert_legacy_nodes_to_grids()       // æ ¼å¼è½¬æ¢

å·¥å…·å‡½æ•°
â”œâ”€â”€ create_aniso_grids()                  // ç½‘æ ¼åˆ›å»º
â”œâ”€â”€ calculate_chiral_aniso()              // æ‰‹å¾è´¡çŒ®
â”œâ”€â”€ calculate_U_aniso()                   // PolyakovåŠ¿èƒ½
â””â”€â”€ calculate_mass_vec()                  // è´¨é‡è®¡ç®—
```

### 5.2 å¯¼å‡ºæ¥å£æ¸…ç†
```julia
# ç°ä»£æ¥å£ (æ¨è)
calculate_omega_thermal, calculate_omega_vacuum, calculate_pressure_aniso_modern
vacuum_energy_integrand, thermal_integrand, create_aniso_grids

# å‘åå…¼å®¹ (è‡ªåŠ¨ä½¿ç”¨ç°ä»£å®ç°)
calculate_pressure_aniso, calculate_pressure_aniso_compat

# å·¥å…·å‡½æ•°
calculate_chiral_aniso, calculate_U_aniso, calculate_mass_vec, ...
```

## 6. ç”¨æˆ·ä½¿ç”¨å»ºè®®

### 6.1 æ–°é¡¹ç›® (æ¨è)
```julia
# ä½¿ç”¨ç°ä»£æ¥å£
params = PNJLAnisoParams(...)
p_grid, t_grid = create_aniso_grids(20, 20)

pressure = calculate_pressure_aniso_modern(phi, Phi1, Phi2, mu, T, p_grid, t_grid, xi)
```

### 6.2 ç°æœ‰é¡¹ç›® (æ— éœ€ä¿®æ”¹)
```julia
# ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œï¼Œè‡ªåŠ¨äº«å—æ€§èƒ½æå‡
pressure = calculate_pressure_aniso(phi, Phi1, Phi2, mu, T, nodes_1, nodes_2, xi)
```

## 7. æ€§èƒ½åŸºå‡†

### 7.1 æµ‹è¯•ç»“æœ
- **æµ‹è¯•é€šè¿‡ç‡**: 31/31 (100%)
- **ç°ä»£æ¥å£æ€§èƒ½**: 23.6ms (ä¼˜å¼‚)
- **å‘åå…¼å®¹**: å®Œå…¨æ”¯æŒ
- **æ•°å€¼ç²¾åº¦**: ä¿æŒé«˜ç²¾åº¦è®¡ç®—

### 7.2 ä¸»è¦æ”¹è¿›
- **ä»£ç ç®€åŒ–**: åˆ é™¤çº¦500è¡Œå†—ä½™ä»£ç 
- **ç»´æŠ¤æ€§**: å¤§å¹…æå‡ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§
- **æ€§èƒ½ä¼˜åŒ–**: ç»Ÿä¸€ä½¿ç”¨æœ€ä¼˜åŒ–çš„ç°ä»£æ¥å£
- **æ¶æ„ä¸€è‡´æ€§**: å®Œå…¨ç¬¦åˆé¡¹ç›®è®¾è®¡ç†å¿µ

## 8. ç»“è®º

### 8.1 ä¸»è¦æˆå°±
1. **å®Œå…¨æ¸…ç†**: åˆ é™¤æ‰€æœ‰æ—§çš„é—­åŒ…å’Œç›´æ¥ç§¯åˆ†å®ç°
2. **æ¶æ„ç»Ÿä¸€**: æ‰€æœ‰è®¡ç®—éƒ½ä½¿ç”¨ç°ä»£ discrete_sum + IntegrationInterface
3. **æ€§èƒ½ä¼˜å¼‚**: ç°ä»£æ¥å£æ€§èƒ½å“è¶Š(23.6ms)
4. **å…¼å®¹æ€§å®Œç¾**: ç°æœ‰ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹
5. **ä»£ç è´¨é‡**: æ˜¾è‘—æå‡å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§

### 8.2 æŠ€æœ¯äº®ç‚¹
- **çº¯å‡½æ•°è®¾è®¡**: å®Œå…¨æ¶ˆé™¤é—­åŒ…ï¼Œæ”¯æŒç¼–è¯‘å™¨ä¼˜åŒ–
- **ç»Ÿä¸€æ¥å£**: discrete_sum + IntegrationInterface çš„å®Œç¾ç»“åˆ
- **è‡ªåŠ¨å¾®åˆ†**: ForwardDiff å®Œå…¨å…¼å®¹
- **ç‰©ç†å‡†ç¡®**: ä¸¥æ ¼æŒ‰ç…§omegaå…¬å¼å®ç°

### 8.3 é¡¹ç›®å½±å“
- **å¼€å‘æ•ˆç‡**: ç®€åŒ–çš„ä»£ç ç»“æ„å¤§å¹…æå‡å¼€å‘å’Œç»´æŠ¤æ•ˆç‡
- **æ€§èƒ½ä¼˜åŠ¿**: ç°ä»£åŒ–å®ç°æä¾›æœ€ä¼˜è®¡ç®—æ€§èƒ½
- **æ‰©å±•æ€§**: ä¸ºå…¶ä»–ç‰©ç†æ¨¡å‹æä¾›æœ€ä½³å®è·µæ¨¡æ¿
- **å¯æŒç»­æ€§**: å»ºç«‹äº†é•¿æœŸå¯ç»´æŠ¤çš„ä»£ç æ¶æ„

ğŸ‰ **PNJL å„å‘å¼‚æ€§æ¨¡å‹ä»£ç æ¸…ç†å’Œæ€§èƒ½ä¼˜åŒ–é¡¹ç›®åœ†æ»¡å®Œæˆï¼**

è¿™æ¬¡é‡æ„æˆåŠŸåœ°å°†ä¸€ä¸ªå¤æ‚çš„ç‰©ç†è®¡ç®—æ¨¡å‹ä»ä¼ ç»Ÿçš„é—­åŒ…å¼æ¶æ„è½¬å˜ä¸ºç°ä»£åŒ–çš„å‡½æ•°å¼æ¶æ„ï¼Œä¸ä»…æå‡äº†æ€§èƒ½ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ä¸€ä¸ªå¯æŒç»­å‘å±•çš„ä»£ç åŸºç¡€ã€‚
